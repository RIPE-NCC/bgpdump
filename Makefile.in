
CC	= @CC@ -fPIC
CFLAGS	= @CFLAGS@
COMPILE  = $(CC) $(CFLAGS) $(INCLUDES)

LD	= @CC@
LDFLAGS	= @LDFLAGS@
SOFLAGS = @SOFLAGS@
RANLIB	= @RANLIB@

SYS_LIBS= @LIBS@

INSTALL  = install
LN_S     = ln -s

prefix   = @prefix@
exec_prefix = @exec_prefix@
bindir   = @bindir@
libdir   = @libdir@
includedir = @includedir@

LIB_H	 = bgpdump_attr.h bgpdump_formats.h bgpdump_lib.h bgpdump_mstream.h
LIB_O	 = bgpdump_lib.o bgpdump_mstream.o cfile_tools.o util.o inet_ntop.o
OTHER    = *.in configure bgpdump.spec README* ChangeLog COPYING*

SOVER_MAJOR = 0
SOVER_MINOR = 0
SOVER_PATCH = 0
SOVER       = $(SOVER_MAJOR).$(SOVER_MINOR).$(SOVER_PATCH)
SONAME      = libbgpdump.so.$(SOVER_MAJOR)

all: libbgpdump.so bgpdump 

libbgpdump.a: $(LIB_H) $(LIB_O) Makefile cfile_tools.h util.h
	ar r libbgpdump.a $(LIB_O)
	$(RANLIB) libbgpdump.a

libbgpdump.so: libbgpdump.a
	$(COMPILE) $(LDFLAGS) $(SOFLAGS) -Wl,-soname,$(SONAME) -o libbgpdump.so.$(SOVER) $(LIB_O) $(SYS_LIBS)
	$(LN_S) libbgpdump.so.$(SOVER) $(SONAME)
	$(LN_S) libbgpdump.so.$(SOVER) libbgpdump.so

example: example.c libbgpdump.so
	$(COMPILE) $(LDFLAGS) -o example example.c libbgpdump.so.$(SOVER) $(SYS_LIBS)

bgpdump: bgpdump.c libbgpdump.so
	$(COMPILE) $(LDFLAGS) -o bgpdump bgpdump.c libbgpdump.so.$(SOVER) $(SYS_LIBS)

check-clean:
	rm -f test_out/*.bgp.gz

check: check-clean bgpdump
	./test.sh

clean: check-clean
	rm -f libbgpdump.so libbgpdump.so.* libbgpdump.a example bgpdump $(LIB_O)

distclean: clean
	rm -Rf config.log config.status *.dSYM core *.core autom4te.cache bgpdump-config.h Makefile
	rm -Rf $(PKG)

install: all
	$(INSTALL) -d $(DESTDIR)$(bindir) $(DESTDIR)$(includedir) $(DESTDIR)$(libdir)
	$(INSTALL) bgpdump $(DESTDIR)$(bindir)
	$(INSTALL) -m 0644 $(LIB_H) $(DESTDIR)$(includedir)
	$(INSTALL) libbgpdump.so.$(SOVER) libbgpdump.a $(DESTDIR)$(libdir)
	$(LN_S) libbgpdump.so.$(SOVER) $(DESTDIR)$(libdir)/$(SONAME)
	$(LN_S) libbgpdump.so.$(SOVER) $(DESTDIR)$(libdir)/libbgpdump.so

PKG=@PACKAGE_NAME@-@PACKAGE_VERSION@
dist:
	mkdir $(PKG)
	ln *.h *.c $(OTHER) $(PKG)
	tar -czf $(PKG).tgz $(PKG)
	rm $(PKG)/* && rmdir $(PKG)

rpm: dist
	rpmbuild -v -ta $(PKG).tgz
